!function(a,b){"object"==typeof module&&"object"==typeof module.exports?module.exports=a.document?b(a,!0):function(a){if(!a.document)throw new Error("dexterjs requires a window with a document");return b(a)}:b(a)}("undefined"!=typeof window?window:this,function(a,b){var c=function(a){return"object"!=typeof a||a.nodeType||null!==a&&a===a.window?!1:a.constructor&&!a.hasOwnProperty.call(a.constructor.prototype,"isPrototypeOf")?!1:!0},d=Array.isArray,e=function L(){var a,b,e,f,g,h,i=arguments[0]||{},j=1,k=arguments.length,l=!1;for("boolean"==typeof i&&(l=i,i=arguments[j]||{},j++),"object"!=typeof i&&(i={});k>j;j++)if(null!=(a=arguments[j]))for(b in a)e=i[b],f=a[b],i!==f&&(l&&f&&(c(f)||(g=d(f)))?(g?(g=!1,h=e&&d(e)?e:[]):h=e&&c(e)?e:{},i[b]=L(l,h,f)):void 0!==f&&(i[b]=f));return i},f={mixins:{timestamp:null,hash:null,pageViewData:null,resWidth:screen.width,resHeight:screen.height,device:a.device?a.device.name:"",url_referrer:document.referrer},clientID:null,clientStorage:{session:{name:"dexterjsSessionID",value:null,domain:".ck12.org",path:"/","max-age":1800,secure:!1},visitor:{name:"dexterjsVisitorID",value:null,domain:".ck12.org",path:"/","max-age":15552e3,secure:!1}},events:{timeSpent:"FBS_TIMESPENT"},apis:{recordEvent:document.location.protocol+"//"+document.location.host+"/dexter/record/event",recordEventBulk:document.location.protocol+"//"+document.location.host+"/dexter/record/event/bulk",recordEventBulkZip:document.location.protocol+"//"+document.location.host+"/dexter/record/event/bulk/zip"},requireUserSignIn:!0,noQueue:!1,trackPageTime:!0,trackScreenResolution:!0,trackReferrer:!0,dexterQueueName:"dexter",dexterQueueAutoFlush:!1,declarativePlugin:{enabled:!1,defaultDomEvent:"click",additionalDomEvents:"",selector:".dxtrack",dataPrefix:"data-dx-"}},g=function M(a){try{var b={},c;for(c in a)a.hasOwnProperty(c)&&("object"==typeof a[c]&&null!==a[c]?b[c]=M(a[c]):b[c]=a[c]);return b}catch(d){throw console.log(d),new Error("Circular Objects Not Supported")}},h=function(a){a="object"==typeof a?a:{};var b=function(){var b=e(!0,{},f);!function h(){var c=null,d=[],f,h,i={},j={},k,l;a.mixins&&(c=g(a.mixins));for(f in a)if(a.hasOwnProperty(f))for(h in b.mixins)if(b.mixins.hasOwnProperty(h)&&h===f){d.push(h);break}for(l=0,k=d.length;k>l;l++)i[d[l]]=a[d[l]];e(!0,j,g(i)),a.mixins=j,null!==c&&e(!0,a.mixins,c),e(!0,b,a)}();var c={config:b,dexterjsPageStartTime:null},d;this.get=function(a){var b=null,e;return void 0===a?null:(d=a.indexOf(":"),b=-1!==d?c[a.substr(0,d)][a.substr(d+1)]:c[a],"object"==typeof b?(e={},H.extend(e,b)):e=b,b)},this.set=function(a,b){if(0===arguments.length)return void 0;var f="object"==typeof b;b=f?g(b):b,d=a.indexOf(":"),-1!==d?c[a.substr(0,d)][a.substr(d+1)]=b:f?e(!0,c[a],b):c[a]=b;var h=document.createEvent("Event");return h.initEvent("dexterjsConfigChangedEvent",!0,!0),h.data=c,document.dispatchEvent(h),null}};return b.prototype=H.prototype,b},i=function N(b){var c,d,g=f.dexterQueueName;b=b?b:a||this;var h=b[g]||[];if(!(h instanceof Array))return console.error(g+" isn't an array"),!1;if(h.hasOwnProperty("config")){for(var i in h.config)H.set("config:"+i,h.config[i]);c=H(h.config)}else c=H();return e(!0,h,c),d=c.get("config"),h.autoFlush=d.dexterQueueAutoFlush,h.push=function(){Array.prototype.push.apply(this,arguments),this.autoFlush&&this.flush()},h.flush=function(){var a;while(this.length)a=this.pop(),this.logEvent(a.eventName,a.payload)},b[g]=h,h},j=function O(a){var b,c,d,e=document.cookie.split(";"),f=e.length;for(b=0;f>b;b++)if(c=e[b].substr(0,e[b].indexOf("=")),d=e[b].substr(e[b].indexOf("=")+1),c=c.replace(/^\s+|\s+$/g,""),c===a)return decodeURIComponent(d);return null},k=function P(a){for(var b="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",c="",d=a;d>0;--d)c+=b[Math.round(Math.random()*(b.length-1))];return c},l=function(){try{return new XMLHttpRequest}catch(a){try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(b){return new ActiveXObject("Msxml2.XMLHTTP")}}},m=function Q(a,b,c){var e,f=/\[\]$/,g="";if(d(b))b.forEach(function(a,b,c){g+=JSON.stringify(a),b!==c.length-1&&(g+=",")}),Q(a,"["+g+"]",c);else if("object"==typeof b)for(e in b)Q(a+"["+e+"]",b[e],c);else c(a,b)},n=function R(a){var b=/%20/g,c,d=[],e=function(a,b){b="function"==typeof b?b():null==b?"":b,d[d.length]=encodeURIComponent(a)+"="+encodeURIComponent(b),d[d.length-1]=d[d.length-1].replace(/'/g,"%2527")};for(c in a)m(c,a[c],e);return d.join("&").replace(b,"+")},o=function S(a,b,c){var d=l(),f,g=function(){return null},h={success:g,error:g,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"}};c=void 0===c?{}:c,c=e(!0,h,c),d.open("POST",a);for(f in c.headers)d.setRequestHeader(f,c.headers[f]);d.onreadystatechange=function(){4===d.readyState&&(200===d.status||304===d.status?c.success():0===d.status?c.offline():c.error())},"application/json"===c.headers["Content-Type"]?d.send(JSON.stringify(b)):d.send(n(b))},p=function T(b,c){if(b="string"==typeof b?{name:b}:b,!b)throw new Error("Unknown Cookie!");var d="";return d+=b.name+"="+(b.value||c||k(25))+";",d+="domain="+(b.domain||a.location.host)+";",d+="path="+(b.path||"/")+";",d+="max-age="+(b["max-age"]||"session")+";",b.secure&&(d+="secure;"),d},q=function(){var a=f,b=-1!==document.location.protocol.indexOf("http")?!0:!1;function c(c,d){b?document.cookie=p(a.clientStorage[c],d):localStorage[a.clientStorage[c].name]=JSON.stringify({id:d,expiry:(new Date).getTime()+1e3*a.clientStorage[c]["max-age"]})}function d(a){var b=(new Date).getTime();try{var c=JSON.parse(localStorage[a]);if(c&&c.expiry>b)return c.id}catch(d){console.debug("Invalid JSON stored in localStorage")}}function e(c){var e;return e=b?j(a.clientStorage[c].name):d(a.clientStorage[c].name),e=e||g(c)}function g(a){var b=k(25);return c(a,b),b}function h(){return e("visitor")}function i(){return e("session")}function l(){c("session",i()),c("visitor",h())}return{getVisitorId:h,getSessionId:i,updateIdExpiry:l}}(),r=function(){var b=a.navigator.onLine,c=[],d=[];function e(){b=!0;for(var a=0;a<c.length;a++)c[a].apply(this)}function f(){b=!1;for(var a=0;a<d.length;a++)d[a].apply(this)}function g(){e()}function h(a){c.push(a)}function i(a){d.push(a)}function j(){return b}return a.addEventListener?(a.addEventListener("online",e,!1),a.addEventListener("offline",f,!1)):(document.body.ononline=e,document.body.onoffline=f),{isOnline:j,addOnOnlineCallback:h,addOnOfflineCallback:i,goOffline:f,triggerOnlineEvent:g}}(),s=function U(b,c,d){var f=this.get("config"),h=g(f.mixins),i={},j=f.apis,k=null,l=null,m=h.clientID||f.clientID,n={},p=typeof d;if("function"===p?n.success=d:"object"===p&&e(!0,n,d),n.offline=function(a){r.goOffline()},"string"!=typeof b){if(!(b instanceof Array))throw new Error("[dexterjs:error] eventType isn't a string");c=b}else c=void 0===c?{}:c;if(!m)throw new Error("Required clientID is missing.");null!==c.memberID&&(h.memberID=a.ads_userid||f.memberID);try{var s=parseInt(h.memberID)}catch(t){throw"INVALID MEMBER ID"}h.memberID=s,h.sessionID=q.getSessionId(),h.visitorID=q.getVisitorId(),e(!0,h,c);for(k in h)h.hasOwnProperty(k)&&null==h[k]&&delete h[k];return p=typeof h.pageViewData,"function"===p?e(!0,h,h.pageViewData()):"object"===p&&(console.debug("Consider adding these values directly to the mixins object."),e(!0,h,h.pageViewData)),c instanceof Array?(l={},l.clientID=m,c.forEach(function(a,b,c){if(a.clientID&&delete a.clientID,!a.eventType)throw new Error("Bulk upload requires events to contain eventType parameter");a.eventType=a.eventType.toUpperCase()}),l.events=c,r.isOnline()?o(j.recordEventBulk,l,n):H.storage.append("queue",l)):(i.eventType=b.toUpperCase(),i.clientID=m,i.payload=JSON.stringify(h),c.timestamp||(c.timestamp=(new Date).toISOString()),r.isOnline()?o(j.recordEvent,i,n):H.storage.append("queue",i)),!0},t={logEvent:s};function u(a){var b={logEvent:t.logEvent};return b}function v(){H.set("dexterjsPageStartTime",(new Date).getTime())}function w(){x()}function x(){var a=100,b=H.storage.read();if(b.queue&&b.queue.length>0)if(b.queue.length>a){var c=b.queue.slice(0,a),d=b.queue.slice(a,b.queue.length);setTimeout(function(){H.logEvent.call(H,c,null,function(){console.debug("Saved "+a+" offline events to server"),H.storage.write("queue",d),x()})},500)}else setTimeout(function(){H.logEvent.call(H,b.queue,null,function(){console.debug("Dumped all offline events to server"),H.storage.dump()})},500)}function y(){var b=H.get("dexterjsPageStartTime"),c=H.get("config");if(!c.trackPageTime)return!1;var d=(new Date).getTime(),e=Math.round((d-b)/1e3),f={URL:document.location.href,memberID:a.ads_userid,sessionID:q.getSessionId(),visitorID:q.getVisitorId(),duration:e};a.adsPage?f.pageType=a.adsPage:a.pageType&&(f.pageType=a.pageType),a.adsSubject&&(f.subject=a.adsSubject),a.adsBranch&&(f.branch=a.adsBranch),a.adsContextEid&&(f.context_eid=a.adsContextEid),H.logEvent(c.events.timeSpent,f)}function z(a){var b={dexterjsOnload:function(){v(),q.updateIdExpiry(),r.isOnline()&&w()},dexterjsOnBeforeUnload:function(){y()},onlineCallback:function(){w()},logEvent:t.logEvent};return b}var A={userEvents:u,factoryEvents:z};function B(a){var b=a.db.name;this.write=function(a){localStorage[b]=a},this.read=function(){return void 0===localStorage[b]?null:localStorage[b]},this.dump=function(){delete localStorage[a.db.name]}}function C(a){var b=null,c={},d;switch(a="object"!=typeof a?{}:a,a=e(!0,{db:{name:"dexterjs",type:"localStorage"},model:{queue:[]},"interface":"localStorage"},a),a["interface"]){default:b=new B(a)}function f(){this.read(),c=e(!0,a.model,c),d=!1}this.set=function(a,b){c[a]=b,d=!0},this.get=function(a){return c[a]},this.save=function(){d=!1,b.write(JSON.stringify(c))},this.read=function(){var a=b.read();return null===a?c:c=JSON.parse(a)},this.write=function(){return 0===arguments.length?this.save():(this.set.apply(this,arguments),void this.save())},this.append=function(a,b){var c=this.get(a),d=typeof c;"object"!==d||"undefined"===d||"boolean"===d?this.write.apply(this,arguments):c instanceof Array?b instanceof Array?this.write(a,c.concat(b)):(c.push(b),this.write(a,c)):(console.warn("[Dexterjs] The value passed is an object literal!\nUsing the extend method instead of append."),this.extend(a,b))},this.extend=function(a,b){this.write(a,e(!0,this.get(a),b))},this.increment=function(a){this.set(a,parseInt(this.get(a))+1)},this.dump=function(){c={},c=e(!0,a.model,c),b.dump()},f.call(this)}function D(){a.console||(a.console={},a.console.log=a.console.warn=a.console.debug=function(){})}function E(a){var b=a.get("config");b="object"!=typeof b?{}:b;var c=document.documentElement,d=Array.prototype.push,f=c.matches||c.webkitMatchesSelector||c.mozMatchesSelector||c.oMatchesSelector||c.msMatchesSelector;function g(){l(),document.removeEventListener("dexterjsConfigChangedEvent",h),document.addEventListener("dexterjsConfigChangedEvent",h)}function h(a){b=e(!0,b,a.data.config),l()}function i(c,d,f){var g={},h=c.getAttribute(f+"domEvent");if(!(h&&d.type!==h||d.type!==b.declarativePlugin.defaultDomEvent)){var i=c.getAttribute(f+"eventname");if(i&&""!==i){for(var j=c.attributes,k=0,l=j.length;l>k;k++){var m=j[k];if(0===m.name.indexOf(f)){var n=m.name.replace(f,"");if("eventname"===n)continue;if("payload"===n){var o=JSON.parse(m.value.replace(/'/g,'"'));g=e(!0,g,o)}else g[n]=m.value}}a.logEvent(i,g)}}}function j(a){var c=b.declarativePlugin.selector,d=b.declarativePlugin.dataPrefix,e=document.querySelector(c);if(e){var g=a.target,h=!1;while(g&&!(h=f.call(g,c)))g=g.parentElement;if(h)try{i(g,a,d)}catch(j){console.log(j)}}}function k(a){document.removeEventListener(a,j,!0),document.addEventListener(a,j,!0)}function l(){if(b.declarativePlugin.enabled){var a=["click"],c=null,e=b.declarativePlugin.defaultDomEvent;e&&(a=[e]),c=b.declarativePlugin.additionalDomEvents,c&&d.apply(a,c.split(/[\s,]+/));for(var f=0;f<a.length;f++)k(a[f])}}g.call(this)}D();var F=null,G=null,H=null,I=null;function J(a){var b=a.get("config");b.trackScreenResolution||(delete b.mixins.resHeight,delete b.mixins.resWidth),b.trackReferrer||delete b.mixins.url_referrer}F=new C({type:"localStorage"}),H=function(a){var b=h(a),c={};e(!0,c,new b),J(c);var d=A.userEvents(c);return c.logEvent=d.logEvent,c},H.extend=e,H.storage=F,function(){var a=h({}),b=new a;for(var c in b)b.hasOwnProperty(c)&&(H[c]=b[c])}(),H.prototype={constructor:H,extend:e,storage:F},G=A.factoryEvents(H),H.logEvent=G.logEvent,a.addEventListener("beforeunload",G.dexterjsOnBeforeUnload),a.addEventListener("load",G.dexterjsOnload),I=new E(H),i(a),r.addOnOnlineCallback(G.onlineCallback),"function"==typeof define&&define.amd&&define([],function(){return H});var K=a.dexterjs;H.noConflict=function(){return a.dexterjs===H&&(a.dexterjs=K),H},"undefined"==typeof b&&(a.dexterjs=H),H.version="0.1.2"});
