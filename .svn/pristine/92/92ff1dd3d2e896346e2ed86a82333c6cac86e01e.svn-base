window.readerAppHelper={dbConnection:null,localConfig:{},init:function(){document.addEventListener("deviceready",function(){document.addEventListener("backButton",function(){var a=!0;"function"==typeof window.readerAppHelper.backButtonHandler&&(a=!window.readerAppHelper.backButtonHandler()),a&&navigator.app.exitApp()},!1),document.addEventListener("online",function(){"login.html"!=window.location.pathname.split("/").pop()||$(".app-container").hasClass("hide")||$("#networkErrorModal,#networkErrorModalOverlay").addClass("hide")},!1),window._platform=device.platform.toLocaleLowerCase(),window.login_check=!1,window.popupactive=!1,console.log(window._platform),window.pageLoadTime=new Date,window._platform.match(/(iPad|iPhone|iPod|iOS)/gi)&&(window._platform="ios"),window._platform.match(/(droid)/gi)&&(window._platform="android"),window._device_model=device.model.toLocaleLowerCase(),window.dexter&&(reader.dexterjs=window.dexterjs)},!1)},initRootPath:function(a){this.rootPath=a,console.log("root path is "+this.rootPath)},checkAppVersion:function(a){"use strict";var b=!0;if(window.readerAppHelper){var c=13569786e5;if(window.readerAppHelper.appLocalStorage&&(c=window.readerAppHelper.appLocalStorage.getItem("lastVersionCheck")||c),Date.now()-c>8496e4){readerAppHelper.checkForServer()?$.get(/*window.API_SERVER_URL*/"https://gamma.ck12.org"+"/assessment/api/app/versions?appName=ck12sims",function(d){if(0===d.responseHeader.status){var e,f;requirejs(["auth/js/version"],function(c){e=c.major,f=d.response.app_version_support[window._platform],null!==f&&void 0!==f&&(e<f.current?(e>=f.min&&(window.readerAppHelper.showUpdateAvailable(!1),window.readerAppHelper.appLocalStorage.setItem("lastVersionCheck",Date.now())),e<f.min&&window.readerAppHelper.showUpdateAvailable(!0),b=!1):(b=!0,window.readerAppHelper.appLocalStorage.setItem("lastVersionCheck",Date.now()),a&&a()))}),d.response.hasOwnProperty("popup_message")&&c<Date.parse(d.response.popup_message.update_time)&&(window.readerAppHelper.showModalPopup(d.response.popup_message.title,d.response.popup_message.body,d.response.popup_message.action,d.response.popup_message.action_label,d.response.popup_message.dismiss_label),window.popupactive=!0)}else b=!0}):b&&a&&a()}else b&&a&&a()}},zipUnzipAllspark:function(){window.localStorage.getItem("allspark")?window.popupactive||window.readerAppHelper.checkLogin():window.readerAppHelper.copyFile()},copyFile:function(){var a=location.href.replace("/index.html",""),b="1.0.8.zip",c=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream?cordova.file.dataDirectory:cordova.file.externalDataDirectory,d=a+"/"+b,e=c+"/1.0.8.zip",f=new FileTransfer;f.download(d,e,function(a){var b=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream?cordova.file.dataDirectory:cordova.file.externalDataDirectory,c=window.SIM_DWL_SRV+"/simulations/common/allspark/1.0.8.zip",d=(encodeURI(c),b+"1.0.8.zip"),e=b;cordova.file.applicationDirectory+"www/";zip.unzip(d,e,function(a){zip.unzip(b+"/1.0.8/assets.zip",e+"/allspark",function(a){console.log("download complete-1"),zip.unzip(b+"/1.0.8/css.zip",e+"/allspark",function(a){console.log("download complete-2"),zip.unzip(b+"/1.0.8/js.zip",e+"/allspark",function(a){console.log("download complete-3"),zip.unzip(b+"/1.0.8/json.zip",e+"/allspark",function(a){console.log("download complete-4"),zip.unzip(b+"/1.0.8/lib.zip",e+"/allspark",function(a){zip.unzip(e+"/allspark/lib/fonts.zip",e+"/allspark/lib",function(a){console.log("download complete-5"),zip.unzip(e+"/allspark/lib/jquery.zip",e+"/allspark/lib",function(a){console.log("download complete-6"),zip.unzip(e+"/allspark/lib/require.zip",e+"/allspark/lib",function(a){console.log("download complete-7"),zip.unzip(e+"/allspark/lib/tinymce.zip",e+"/allspark/lib",function(a){console.log("download complete-8"),window.localStorage.setItem("allspark",!0),window.readerAppHelper.cleanZipfile("1.0.8"),window.readerAppHelper.ClearDirectory("1.0.8"),window.localStorage.removeItem("simUpdateData"),window.popupactive||window.readerAppHelper.checkLogin()})})})})})})})})})})},function(a){console.log(a),alert(a)})},ClearDirectory:function(a){function b(a){alert("FILE SYSTEM FAILURE")}function c(c){c.root.getDirectory("Android/data/org.ck12.simulations/files/"+a,{create:!0,exclusive:!1},function(a){a.removeRecursively(function(){console.log("Remove Recursively Succeeded")},b)},b)}var a=a.toString();window.localStorage.removeItem(a),window.requestFileSystem(LocalFileSystem.PERSISTENT,1048576,c,b)},cleanZipfile:function(a){function b(a){alert("FILE SYSTEM FAILURE")}function c(c){c.root.getFile("Android/data/org.ck12.simulations/files/"+a+".zip",{create:!0,exclusive:!1},function(c){c.remove(function(){window.localStorage.removeItem(a),console.log("Vipin Bhai Chaa Gaye")},b)},b)}var a=a.toString();window.requestFileSystem(LocalFileSystem.PERSISTENT,1048576,c,b)},runInstallScripts:function(a){"use strict";console.log("Running install scripts")},checkLogin:function(){readerAppHelper.checkForServer()?(window.login_check=!0,$.get(window.API_SERVER_URL+"/assessment/api/get/info/my",function(a){0!==a.responseHeader.status?window.location.href="auth/login.html":(void 0!=typeof Storage&&readerAppHelper.setUserInfo(a.response.member),window.location.href="www/index.html")},"json")):this.getUserInfo()&&this.getUserInfo().uID?(window.login_check=!0,console.log(this.getUserInfo().uID),window.location.href="www/index.html"):this.checkForNetwork()},resultValidation:function(a){return a.hasOwnProperty("response")?(a=a.response,a.hasOwnProperty("message")&&(a="")):a="",a},checkForPasswordChange:function(a){try{return JSON.parse(a).response?(a=JSON.parse(a).response,a.message&&(a.message.match("Incorrect password")?alert("The Password you have entered in the Current Password field is incorrect. Please check it again to make sure it is spelled correctly."):a.message.match("missing password")?alert("You did not enter a password. Please enter your password and try again."):alert(a.message),a="")):(a="",alert("Sorry, we could not update the user info right now. Please try again later or contact our customer support.")),a}catch(b){return console.log(b),""}},loginSuccess:function(a,b){readerAppHelper.bindGPlayClickEvent(),a&&$.get(window.API_SERVER_URL+"/assessment/api/get/info/my",function(a){0===a.responseHeader.status?a.response.member&&(welcomeName=a.response.member.firstName+" "+a.response.member.lastName||a.response.member.email||a.response.member.login,void 0!=typeof Storage&&(localStorage.setItem("user",welcomeName),readerAppHelper.setUserInfo(a.response.member)),b&&b.close(),$(".landing-page").addClass("hide"),$(".app-container").removeClass("hide"),window.location.href="../www/index.html"):(console.log("Error getting user info"),console.log(a.response.message),b&&b.close(),$("#message").html("There was an error problem signing you in. Please try again or try later."))},"json")},bindGPlayClickEvent:function(){$(".message-googleplaySignin").removeClass("hide").html(""),$(".message-googleplaySignup").removeClass("hide").html(""),$(".signin-googleplay").off("click").on("click",function(a){$(".signin-googleplay").off("click"),mode=$(this).data("mode"),"signin"===mode?$(".message-googleplaySignin").removeClass("hide").html("signing in ..."):"signup"===mode&&$(".message-googleplaySignup").removeClass("hide").html("signing up ..."),readerAppHelper.googlePlayLogin()})},loginError:function(a,b){b&&b.close(),readerAppHelper.bindGPlayClickEvent(),"1001"!==a&&"1002"!==a&&$("#message").html("There was a problem signing you in. Please try again or try later.")},googleLogin:function(){if(!readerAppHelper.checkForServer())return readerAppHelper.checkForNetwork(),void console.debug("Network error, Aborting the login");var a=window.API_SERVER_URL+"/auth/login/member/google?url="+escape(window.API_SERVER_URL+"/auth/verify/member/google"),b=window.open(a,"_blank","location=no");$(b).on("loadstart",function(a){var c=a.originalEvent.url;a.preventDefault();var d=/ck12.org\/auth\/verify\/member\/google\?code=(.+)$/.exec(c),e=/\?error=(.+)$/.exec(c);d?($("#message").html("signed in ..."),$.get(c,function(a){readerAppHelper.loginSuccess(a,b)})):e&&readerAppHelper.loginError(e,b)})},googlePlayLogin:function(){if(!readerAppHelper.checkForServer())return readerAppHelper.checkForNetwork(),void console.debug("Network error, Aborting the login");if("android"!=window._platform||window._device_model.match(/chrome/gi))readerAppHelper.googleLogin(),readerAppHelper.bindGPlayClickEvent();else{var a={};a=function(a){var b=null;if(a.length>0){var c={};c.success=function(a){clearInterval(b),loginurl=window.API_SERVER_URL+"/auth/login/member/google?url=&appLogin=True",console.debug(loginurl),$.get(loginurl,function(b){url=window.API_SERVER_URL+"/auth/verify/member/google",console.debug(url),$.get(url,{token:a},function(a){readerAppHelper.loginSuccess(a)})})},c.error=function(a,c){clearInterval(b),console.debug("There was error accessing user data by using google play login"),console.debug(a),readerAppHelper.loginError(a)},window.identity.getAuthToken({interactive:!0},c),b=window.setInterval(function(){window.identity.getAccounts({},function(){})},2e3)}else readerAppHelper.googleLogin(),readerAppHelper.bindGPlayClickEvent()},window.identity.getAccounts({},a)}},userLogin:function(a,b,c){readerAppHelper.setStatus("signing in ..."),readerAppHelper.logout(function(d){readerAppHelper.login(a,b,c)})},login:function(a,b,c){$.ajax({type:"POST",url:window.API_SERVER_URL+"/auth/login/member",data:{login:a,token:b,authType:"ck-12",remember:"true"},dataType:"json",success:function(a){void 0!=typeof Storage&&readerAppHelper.setUserInfo(a.response),c(a)}})},signUp:function(a){var b=this,c=a.givenName;return readerAppHelper.checkForServer()?$.ajax({type:"POST",url:window.API_SERVER_URL+"/auth/create/member",data:a,dataType:"json",success:function(d){0===d.responseHeader.status?window.readerAppHelper.login(a.email,a.token,function(){$(".landing-page").addClass("hide"),$(".app-container").removeClass("hide"),b.thankYouSignUp(c),b.getUserInfoOkayPage({success:function(a){console.log(a),readerAppHelper.setUserInfo(a.response)},error:function(a){alert("Error in sign up please try again"),window.location.href="login.html"}})}):(console.log(d.response.message),$("#message-signup").removeClass("hide"),-1===d.response.message.indexOf("http")&&-1===d.response.message.indexOf("HTTP")?$("#message-signup").html(d.response.message):$("#message-signup").html("There was a problem signing you in. Please try again or try later."))}}):void this.checkForNetwork()},thankYouSignUp:function(a){requirejs(["templates/profile.builder.templates","underscore","controllers/profile.builder","views/profile.builder.view","services/ck12.locationService"],function(b,c,d,e,f){function g(){window.location.href="../www/index.html"}function h(){$("#thankYou-okayButton").off("click.okay").on("click.okay",function(){window.readerAppHelper.checkForServer()?d.load("profileBuilder",e,f,g):window.readerAppHelper.checkForNetwork()})}var i=c.template(b.THANKYOU_SIGNUP,null,{variable:"data"}),j=i({userName:a});$(".app-page").empty(),$(".app-page").append(j),h()})},getUserInfoOkayPage:function(a){$.ajax({url:window.API_SERVER_URL+"/auth/get/info/my",success:function(b){b=JSON.parse(b),0===b.responseHeader.status?a&&a.success(b):a&&a.error(b)},error:function(b){a&&a.error(b)}})},validateEmail:function(a){readerAppHelper.checkForServer()?$.ajax({type:"POST",url:window.API_SERVER_URL+"/auth/validate/member/email",data:{email:a.email},dataType:"json",success:function(b){b?a&&a.success&&a.success(b):a&&a.error&&a.error(b)}}):this.checkForNetwork()},getSessionID:function(){var a=30,b=readerAppHelper.appLocalStorage.getItem("sessionID"),c=new Date;if(b){var d=b.split("_"),e=parseInt(d[1],10);c.getTime()-e>60*a*1e3&&(b=null)}return b||(b=readerAppHelper.getRandomString(25)+"_"+c.getTime(),readerAppHelper.appLocalStorage.setItem("sessionID",b)),b.split("_")[0]},getRandomString:function(a){for(var b="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",c="",d=a;d>0;--d)c+=b[Math.round(Math.random()*(b.length-1))];return c},logAppADSEvent:function(a,b){if(!window.dexterjs)return void console.log("logAppADSEvent: Could not initialize dexterjs");var c=(window.ADS_RECORD_EVENT_API,window.ADS_RECORD_BULK_API,readerAppHelper.getUserInfo()),d=c.uID||"2";dexterjs.set("config",{clientID:window.FBS_CLIENT_ID,memberID:d,trackPageTime:!1,apis:{recordEvent:window.ADS_SERVER_API,recordEventBulk:window.ADS_SERVER_API+"/bulk",recordEventBulkZip:window.ADS_SERVER_API+"/bulk/zip"}}),b=b||{},window.device?(b.app_platform=window.device.platform,b.device=device.model,console.log("device.model: "+device.model)):console.log("logAppADSEvent: Cannot get device information"),b.app_version="1.0",b.app_name="Simulations",b.memberID=d,b.sessionID=readerAppHelper.getSessionID(),console.log("Logging ADS event: "+a+", payload: "+JSON.stringify(b)),window.dexterjs.logEvent(a,b),window.analytics&&(window.analytics.trackEvent(JSON.stringify(b),a),console.log("Google Events"))},addADSEvents:function(a,b){this.logAppADSEvent(a,b)},logScreenViewEventForApp:function(a,b){try{if(window.analytics){if(window.analytics){var c=window.reader_configs.APP_GA_TRACKER.android_tracker;console.log("[reader.js:logScreenViewEventForApp] pageName: "+a+", id: "+c),window.analytics.startTrackerWithId(c),window.analytics.trackView(a),console.log("Google Events")}}else console.log("Cannot initialize window.analytics");if(window.dexterjs){var d={};d.screeen_name=a,d.sessionID=readerAppHelper.getSessionID(),this.addADSEvents("APP_SCREEN_VIEW",d)}else console.log("Cannot initialize window.dexterjs")}catch(e){}},getGaSetUserId:function(){if(window.analytics){var a=readerAppHelper.getUserInfo(),b=a.uID||"2";window.analytics.setUserId(b),console.log("Google yracking userID : "+b)}else console.log("unable to track userId")},logout:function(a){"use strict";readerAppHelper.checkForServer()?window.cookies.clear(function(b){a?(window.identity.removeCachedAuthToken({}),readerAppHelper.clearUserInfo(),localStorage.removeItem("user"),console.log("No local cache found."),a(b)):(window.location.href="index.html",window.readerAppHelper.logScreenViewEventForApp("Welcome"))},function(){console.log("clearing cookies failed"),$.get(window.API_SERVER_URL+"/auth/signout",function(b){window.identity.removeCachedAuthToken({}),readerAppHelper.clearUserInfo(),localStorage.removeItem("user"),a?(console.log("No local cache found."),a(b)):(window.location.href="index.html",window.readerAppHelper.logScreenViewEventForApp("Welcome"))})}):this.checkForNetwork()},setStatus:function(a){a+="<br><br>";try{$("#status").prepend(a)}catch(b){}console.log(a)},initHeader:function(a){function b(){$("body.practice-app-view").removeClass("slide-left"),$("#networkErrorModalOverlay").css("opacity",0),setTimeout(function(){$("#userInfoMenu").addClass("hide"),$("#networkErrorModalOverlay").addClass("hide")},200)}var c="ontouchstart"in document.documentElement;c?("function"==typeof a.backButtonHandler&&$("#backButton").length>0&&$("#backButton").off("touchend.back").on("touchend.back",a.backButtonHandler),$("#networkErrorModalOverlay").off("touchend").on("touchend",function(a){b()})):("function"==typeof a.backButtonHandler&&$("#backButton").length>0&&$("#backButton").off("click.back").on("click.back",a.backButtonHandler),$("#networkErrorModalOverlay").off("click").on("click",function(a){b()}))},appLocalStorage:{getItem:function(a){var b=null;return window.localStorage?(b=JSON.parse(window.localStorage.getItem("reader_app_config")),b&&b[a]?b[a]:!1):!1},setItem:function(a,b){var c=null;return window.localStorage?(c=JSON.parse(window.localStorage.getItem("reader_app_config")),c||(c={}),c[a]=b,c=JSON.stringify(c),window.localStorage.setItem("reader_app_config",c),!0):!1}},setUserInfo:function(a){var b=a.firstName+" "+a.lastName||"",c=a.imageURL||"",d=a.uID||a.id||"",e=a.email||"",f=a.login===a.defaultLogin?"":a.login;c&&(c=-1!==c.indexOf("flx")?window.API_SERVER_URL+c:c),this.appLocalStorage.setItem("userName",b),this.appLocalStorage.setItem("userImage",c),this.appLocalStorage.setItem("uID",d),this.appLocalStorage.setItem("email",e),this.appLocalStorage.setItem("login",f),this.appLocalStorage.setItem("launcher-app",!0)},clearUserInfo:function(){this.appLocalStorage.setItem("userName",""),this.appLocalStorage.setItem("userImage",""),this.appLocalStorage.setItem("uID",""),this.appLocalStorage.setItem("email",""),this.appLocalStorage.setItem("login",""),this.appLocalStorage.setItem("subject",""),this.appLocalStorage.setItem("branch",""),this.appLocalStorage.setItem("practiceHandle",""),this.appLocalStorage.setItem("launcher-app",!0)},getUserInfo:function(){return{userName:this.appLocalStorage.getItem("userName"),userImage:this.appLocalStorage.getItem("userImage"),uID:this.appLocalStorage.getItem("uID"),email:this.appLocalStorage.getItem("email"),login:this.appLocalStorage.getItem("login"),"launcher-app":this.appLocalStorage.getItem("launcher-app")}},checkForNetwork:function(){var a=null;return $("#networkErrorModal").length>0?$("#networkErrorModal,#networkErrorModalOverlay").removeClass("hide"):(a=window.readerAppHelper.getNetworkErrorModal(),$("body").append(a),$("#networkErrorModal").off("click").on("click",".closeNetworkModal",function(){navigator.connection.type;readerAppHelper.checkForServer()&&("login.html"!=window.location.pathname.split("/").pop()||$(".app-container").hasClass("hide")?window.location.reload(!1):$("#networkErrorModal,#networkErrorModalOverlay").addClass("hide"))})),navigator.onLine},checkForServer:function(){var a=new XMLHttpRequest,b=window.API_SERVER_URL+"/assessment/api/app/versions?appName=ck12sims",c=Math.round(1e4*Math.random());a.open("HEAD",b+"?subins="+c,!1);try{return a.send(),a.status>=200&&a.status<304?!0:!1}catch(d){return!1}},getModalPopupHTML:function(a,b,c,d,e){"use strict";var f='<div class="no-network" id = "messagePopupModal"><div class="icon-container"><i class="icon-notice"></i></div><div class="message-title">'+a+'</div><div class="message-body">'+b+"</div><div>";return c&&d&&(f+='<input type = "button" id = "popup_modal_act" class="button tangerine small" value = "'+d+'"><br>'),e||(e="OK, got it"),f+='<input type="button" id="popup_modal_dismiss" class="button tangerine small" value="'+e+'">',f+="</div></div></div>"},getNetworkErrorModal:function(){var a=[];return a.push('<div class="no-network" id="networkErrorModal">'),a.push('<span class="icon-network icon-sym"></span>'),a.push('<div class="message-body">Activities aren\'t available right now!</div>'),a.push("<p>Either you don't have a network <br/>connection or our server is acting up.</p>"),a.push('<div><input type="button" class="button dusty-grey dismiss-req closeNetworkModal " value="Retry"></div></div>'),a.push("</div>"),$("body").append('<div id="networkErrorModalOverlay" class="reveal-bg"></div>'),a.join("")},showUpdateAvailable:function(a){"use strict";var b=null;$("#versionErrorModal").length>0?$("#versionErrorModal, #networkErrorModalOverlay").removeClass("hide"):(b=window.readerAppHelper.getVersionErrorModal(a),$("body").append(b),$("#versionErrorModal .update").off("click").on("click",function(){window.readerAppHelper.ClearDirectory("allspark"),window.localStorage.removeItem("allspark"),window.localStorage.removeItem("simUpdateData"),window.open(encodeURI(APP_DOWNLOAD_URL[window._platform]),"_system"),navigator.app.exitApp()}),a||$("#versionErrorModal .dismissUpdate").off("click").on("click",function(){$("#versionErrorModal,#networkErrorModalOverlay").addClass("hide"),0==window.login_check&&window.readerAppHelper.zipUnzipAllspark()}))},showModalPopup:function(a,b,c,d,e,f){"use strict";var g=null;$("#networkErrorModalOverlay").length<=0&&$("body").append('<div id="networkErrorModalOverlay" class="reveal-bg"></div>'),$("#messagePopupModal").length>0&&$("#messagePopupModal").remove(),g=window.readerAppHelper.getModalPopupHTML(a,b,c,d,e),$("body").append(g),$("#popup_modal_act")&&(c&&0!==c.indexOf("http")&&(c=cordova.file.applicationDirectory+c),$("#popup_modal_act").off("click").on("click",function(a){return function(){window.readerAppHelper.runInstallScripts(function(){0===a.indexOf("http")?window.open(a,"_system","location=yes"):("SC"===f&&(window.readerAppHelper.appLocalStorage.setItem("scOff",!1),window.readerAppHelper.appLocalStorage.setItem("summerChallengePrompted","")),window.location.href=a)})}}(c))),$("#popup_modal_dismiss")&&$("#popup_modal_dismiss").off("click").on("click",function(){$("#messagePopupModal, #networkErrorModalOverlay").addClass("hide"),setTimeout(function(){0==window.login_check&&(window.popupactive=!1,window.readerAppHelper.zipUnzipAllspark())},1500)})},getModalPopupHTML:function(a,b,c,d,e){"use strict";var f='<div class="no-network" id = "messagePopupModal"><div class="icon-container"><i class="icon-notice"></i></div><div class="message-title">'+a+'</div><div class="message-body">'+b+"</div><div>";return c&&d&&(f+='<input type = "button" id = "popup_modal_act" class="button tangerine small" value = "'+d+'"><br>'),e||(e="OK, got it"),f+='<input type="button" id="popup_modal_dismiss" class="button tangerine small" value="'+e+'">',f+="</div></div></div>"},getVersionErrorModal:function(a){"use strict";var b=[];return b.push('<div class="no-network" id="versionErrorModal">'),a?(b.push('<div class="message-body">Please update</div>'),b.push("<p>Looks like you're using a version of the app that is no longer supported!</p>"),b.push('<div><input type="button" class="button dusty-grey update" value="Update"></div></div>')):(b.push('<div class="message-body">Update available</div>'),b.push("<p>A new version of CK-12 is available!</p>"),b.push('<div><input type="button" class="button dusty-grey update" value="Update"><input type="button" style="margin-left:20px" class="button dusty-grey dismissUpdate" value="Not now"></div></div>')),$("body").append('<div id="networkErrorModalOverlay" class="reveal-bg"></div>'),b.join("")},initAjaxSetup:function(){$.ajaxSetup({error:function(){readerAppHelper.checkForNetwork()}})}},document.addEventListener("deviceready",function(){setTimeout(function(){},11)},!1);