define(["jquery","templates/profile.builder.templates"],function(a){"use strict";function b(){function b(b){var e=b.member,f=(b.grades,b.allRoles,e.lastName?e.firstName+" "+e.lastName:e.firstName);if(a("#userName").empty(),a("#userName").val(f+"."),a("#userName").attr("size",a("#userName").val().length),e.role&&"member"!==e.role.name,e.imageURL?(a(".uploadimage_btn_display").text("Edit Photo"),-1!==e.imageURL.indexOf("flx")?a("#profileImage").attr("src",window.API_SERVER_URL+e.imageURL):a("#profileImage").attr("src",e.imageURL)):a(".uploadimage_btn_display").text("Upload a photo"),e.address){d={},d.city=e.address.city,d.state=e.address.province,d.province=e.address.province,d.country=e.address.country,d.zip=e.address.postalCode;var h="",i="",j=d.country.split(": ");"US"===j[0]?(i=d.city+", "+d.state,h=d.city+", "+d.province,d.zip&&(h+=" "+d.zip),a("#usLocation").val(h),a("#usLocationContainer").addClass("hide"),a("#internationalLocationContainer").removeClass("hide")):(i=d.city+", "+j[1],h=d.city+", "+d.province+", "+j[1],d.zip&&(h+=" "+d.zip),a("#internationalLocation").val(h),a("#usLocationContainer").removeClass("hide"),a("#internationalLocationContainer").addClass("hide")),a(".js_location_select_link").text(i+".")}g(),c.initImageUploader(),c.loadLocationService()}function f(d,f,g){e=g,require(["controllers/profile.builder","text!templates/profile.builder.html"],function(g,h){d&&d.member&&1===d.member.isProfileUpdated?e():d&&d.member&&(h=h.replace("@@serverName@@",window.API_SERVER_URL),c=g,a("#"+f).html(h),a("#continue_btn").prop("disabled",!0),a("#"+f).addClass("app-page-Image"),b(d),readerAppHelper.logScreenViewEventForApp("Profile"))})}function g(){function b(){a("#roleOptions").removeClass("no-display"),a("#locationSelectionFormContainer").addClass("hide"),a("#gradeSelectionFormContainer").addClass("hide"),a(".skip-continue-buttons").removeClass("hide"),a("#button-continue")[0].value="Next",a(".app-page").addClass("animator"),a("#selectUserRole").addClass("edit-mode"),a("#location-selector").removeClass("edit-mode"),a("#gradeSelector").removeClass("edit-mode"),a("#profileBuilderModal").removeClass("screenslideinbottom-100px").removeClass("screenslideinbottom-150px").addClass("screenslideoutbottom-0px"),a("#profileBuilderModal-inputDetails").removeClass("hide").removeClass("slideoutBottom").addClass("slideinBottom")}function f(){a("#roleOptions").addClass("no-display"),a("#locationSelectionFormContainer").removeClass("hide"),a("#gradeSelectionFormContainer").addClass("hide"),a("#usLocationContainer").removeClass("hide"),a("#internationalLocationContainer").addClass("hide"),a(".skip-continue-buttons").removeClass("hide"),a("#button-continue")[0].value="Next",a(".app-page").addClass("animator"),a("#selectUserRole").removeClass("edit-mode"),a("#location-selector").addClass("edit-mode"),a("#gradeSelector").removeClass("edit-mode"),a("#profileBuilderModal-inputDetails").removeClass("hide").removeClass("slideoutBottom").addClass("slideinBottom"),a("#profileBuilderModal").addClass("screenslideinbottom-100px").removeClass("screenslideinbottom-150px").removeClass("screenslideoutbottom-0px")}function g(){a("#roleOptions").addClass("no-display"),a("#locationSelectionFormContainer").addClass("hide"),a("#gradeSelectionFormContainer").removeClass("hide"),a(".skip-continue-buttons").removeClass("hide"),a("#button-continue")[0].value="Done",a(".app-page").addClass("animator"),a("#selectUserRole").removeClass("edit-mode"),a("#location-selector").removeClass("edit-mode"),a("#gradeSelector").addClass("edit-mode"),a("#profileBuilderModal-inputDetails").removeClass("hide").removeClass("slideoutBottom").addClass("slideinBottom"),a("#profileBuilderModal").removeClass("screenslideinbottom-100px").addClass("screenslideinbottom-150px").removeClass("screenslideoutbottom-0px")}function h(){a(".app-page").removeClass("animator"),a("#profileBuilderModal-inputDetails").addClass("slideoutBottom").delay(201).queue(function(){a("#profileBuilderModal-inputDetails").addClass("hide").dequeue()}),a("#profileBuilderModal").removeClass("screenslideinbottom-100px").removeClass("screenslideinbottom-150px").addClass("screenslideoutbottom-0px")}function i(b){var c=b.grades,d=b.role,e=[],f="",g=0;if(c.length){if("teacher"===d){a("#gradeSelectionFormContainer #gradeSelectionForm .selectedGrade").each(function(){e[e.length]=a(this)[0].innerHTML+""});for(var h=0;h<c.length;h++){var i=e[h];if(a("#gradeSelectionFormContainer #gradeSelectionForm .selectedGrade").length){a(".js_grade_select_link").empty(),f?f+=", "+i:f=i,g+=1;var j="";g>1&&(j="s"),a(".js_grade_select_link").val("grade"+j+" "+f+"."),a(".js_grade_select_link").removeClass("bg-pink-semitransparent").addClass("bg-black-semitransparent"),a("#grade-selector-link").addClass("subscriptRemover")}else a(".js_grade_select_link").append("these grades")}}else if("student"===d){var i=c[0],k="";"Kindergarten"===i?(a(".js_grade_select_link").empty(),a(".js_grade_select_link").val(i+"."),a(".js_grade_select_link").removeClass("bg-pink-semitransparent").addClass("bg-black-semitransparent"),a("#grade-selector-link").addClass("subscriptRemover")):(k="1"===i?"st":"2"===i?"nd":"3"===i?"rd":"th",a(".js_grade_select_link").empty(),a(".js_grade_select_link").val(i+k+" grade."),a(".js_grade_select_link").removeClass("bg-pink-semitransparent").addClass("bg-black-semitransparent"),a("#grade-selector-link").addClass("subscriptRemover"))}}else a(".js_grade_select_link").empty(),"teacher"===d?a(".js_grade_select_link").val(""):"student"===d&&a(".js_grade_select_link").val("");a("#gradeInput").attr("size",a("#gradeInput").val().length)}function j(b,e){b.preventDefault();var f,g,h,i=new Array;if("teacher"===e.role?f="5":"student"===e.role&&(f="7"),f||(f="5"),a("#gradeSelectionForm .selectedGrade").each(function(){i[i.length]=a(this).attr("id")}),h={roleID:f},"false"===a("#profileImage").data("default-image")&&(g=a("#profileImage").data("image-url"),h.imageURL=g),d){a.each(d,function(a,b){h[a]=b});var j={};j.referrer="profile_builder",window._ck12&&_ck12.logEvent("FBS_LOCATION_INFO",j)}i&&(h.gradeIDs=JSON.stringify(i),readerAppHelper.logAppADSEvent("APP_ACTION",{action_name:"Profile/SelectGrade",input_value:i,screen_name:"Profile",action_type:"link"})),c.saveUserProfile(k,h)}function k(a){console.log(a),e()}var l={role:"student",location:"",grades:[]};a("#selectUserRole").off("click.okay").on("click.okay",function(){b()}),a("#roleOption-1").off("click.okay").on("click.okay",function(){a("#role_opt").empty().val("teacher."),a(".message").empty().append("I teach"),a("#gradeInput").attr("placeholder","these grades"),a("#selectUserRole").removeClass("bg-pink-semitransparent").addClass("bg-black-semitransparent"),a("#roleOption-1").addClass("bg-green-semitransparent"),a("#roleOption-2").removeClass("bg-green-semitransparent"),a("#roleOption-1").prop("checked")||a("#roleOption-2").prop("checked"),a("#continue_btn").prop("disabled",!1),a("#continue_btn").removeClass("disabled"),a(".grades-row-2").children().removeClass("selectedGrade"),a(".grades-row-3").children().removeClass("selectedGrade"),a(".grades-row-4").children().removeClass("selectedGrade"),a("#grades-subRow-1").empty().append("Select grades:"),a("#grade-selector-link").removeClass("subscriptRemover"),a("#te-su").html("I teach"),l.role="teacher",a(".js_grade_select_link").empty(),a(".js_grade_select_link").val(""),l.grades=[],a("#gradeInput").attr("size",a("#gradeInput").val().length),a(".js_grade_select_link").removeClass("bg-black-semitransparent"),readerAppHelper.logAppADSEvent("APP_ACTION",{action_name:"Profile/SelectRole",input_value:l.role,screen_name:"Profile",action_type:"link"})}),a("#roleOption-2").off("click.okay").on("click.okay",function(){a("#role_opt").empty().val("student."),a(".message").empty().append("I'm in"),a("#gradeInput").attr("placeholder","this grade"),a("#selectUserRole").removeClass("bg-pink-semitransparent").addClass("bg-black-semitransparent"),a("#roleOption-1").removeClass("bg-green-semitransparent"),a("#roleOption-2").addClass("bg-green-semitransparent"),(a("#roleOption-1").prop("checked")||a("#roleOption-2").prop("checked"))&&a("#continue_btn").prop("disabled",!1),a("#continue_btn").prop("disabled",!1),a("#continue_btn").removeClass("disabled"),a(".grades-row-2").children().removeClass("selectedGrade"),a(".grades-row-3").children().removeClass("selectedGrade"),a(".grades-row-4").children().removeClass("selectedGrade"),a("#grades-subRow-1").empty().append("Select grade:"),a("#grade-selector-link").removeClass("subscriptRemover"),a("#te-su").html("I'm in"),l.role="student",a(".js_grade_select_link").empty(),a(".js_grade_select_link").val(""),l.grades=[],a("#gradeInput").attr("size",a("#gradeInput").val().length),a(".js_grade_select_link").removeClass("bg-black-semitransparent"),readerAppHelper.logAppADSEvent("APP_ACTION",{action_name:"Profile/SelectRole",input_value:l.role,screen_name:"Profile",action_type:"link"})}),a("#location-selector").off("click.okay").on("click.okay",function(){f()}),a(".us-location-link").off("click.okay").on("click.okay",function(){a("#internationalLocationContainer").addClass("hide"),a("#usLocationContainer").removeClass("hide")}),a(".international-location-link").off("click.okay").on("click.okay",function(){a("#internationalLocationContainer").removeClass("hide"),a("#usLocationContainer").addClass("hide")}),a("#grade-selector").off("click.okay").on("click.okay",function(){g()}),a(document).mouseup(function(b){var c=a("#profileBuilderModal-inputDetails"),d=a("#selectUserRole"),e=a("#location-selector"),f=a(".js_grade_select_link");c.is(b.target)||0!==c.has(b.target).length||c.hasClass("slideoutBottom")||d.is(b.target)||e.is(b.target)||f.is(b.target)||(a(".app-page").removeClass("animator"),c.addClass("slideoutBottom").delay(201).queue(function(){c.addClass("hide").dequeue()}),a("#profileBuilderModal").removeClass("screenslideinbottom-100px").removeClass("screenslideinbottom-150px").addClass("screenslideoutbottom-0px"))}),a(".grades").off("click.okay").on("click.okay",function(b){if("teacher"===l.role){a(b.currentTarget).toggleClass("selectedGrade");var c=b.currentTarget.innerHTML+"";-1==l.grades.indexOf(c)?l.grades.push(c):l.grades.splice(l.grades.indexOf(c),1)}else{a(".grades-row-2").children().removeClass("selectedGrade"),a(".grades-row-3").children().removeClass("selectedGrade"),a(".grades-row-4").children().removeClass("selectedGrade"),a(b.currentTarget).addClass("selectedGrade"),l.grades=[];var c=b.currentTarget.innerHTML+"";l.grades.push(c)}i(l)}),a(".close-popup").off("click").on("click",function(){h()}),a("#continue_btn").off("click.create").on("click.create",function(b){a("#continue_btn").hasClass("disabled")||(window.readerAppHelper.checkForServer()?j(b,l):window.readerAppHelper.checkForNetwork())}),a("#button-continue").off("click.create").on("click.create",function(b){if(a("#button-continue").hasClass("disabled"));else{if(a("#profileBuilderModal").hasClass("screenslideinbottom-100px"))if(a("#internationalLocationContainer").hasClass("hide")){var c=a("#usLocation").val();""!=c&&(c=c.split(",")[0]+","+c.split(",")[1]+"."),a(".js_location_select_link").val(c)}else{var c=a("#internationalLocation").val();""!=c&&(c=c.split(",")[0]+","+c.split(",")[c.split(",").length-1]+"."),a(".js_location_select_link").val(c)}"selectUserRole"===a(".edit-mode").attr("id")?f():"location-selector"===a(".edit-mode").attr("id")?g():"gradeSelector"===a(".edit-mode").attr("id")&&(h(),a("#profileBuilderModal").removeClass("screenslideinbottom-100px").removeClass("screenslideinbottom-150px").addClass("screenslideoutbottom-0px"))}});var m=function(b){d=b;var c="",e=d.country.split(": ");c="US"===e[0]?d.city+", "+d.state:d.city+", "+e[1],readerAppHelper.logAppADSEvent("APP_ACTION",{action_name:"Profile/SelectLocation",input_value:c,screen_name:"Profile",action_type:"inputBox"}),a(".js_location_select_link").val(c+"."),a(".js_location_select_link").removeClass("bg-pink-semitransparent").addClass("bg-black-semitransparent"),a("#location-selector").addClass("subscriptRemover")};c.setLocationChangedCallback(m)}this.render=f,this.profileImageUploadCallback=function(b){b.uri&&(a("#profileImage").attr("src",window.API_SERVER_URL+b.display_uri),a("#profileImage").data("image-url",b.uri),readerAppHelper.appLocalStorage.setItem("userImage",b.uri),a("#profileImage").data("default-image","false"),a("#ajaxLoadingWait").addClass("no-display"),a("#profileImage").removeClass("no-display"),readerAppHelper.logAppADSEvent("APP_ACTION",{action_name:"Profile/UploadPhoto",input_value:"",screen_name:"Profile",action_type:"input"}))}}var c,d,e;return new b});